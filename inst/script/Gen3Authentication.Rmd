---
title: Gen3 Authentication Demo
date: July 20, 2020
output:
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
---

<img src="anvillogom.png" style="position:absolute;top:0px;right:0px;" />


# Intro

This is a demo of how to login and query Gen3 from R.

This is based on:

* https://gen3.org/resources/user/using-api/
* https://gen3.org/resources/developer/flat-model-api/
* https://graphql.org/learn/queries/
* https://graphql.org/learn/introspection/

# Load Libraries

```{r}
library(httr)
library(jsonlite)
```

# Get Gen3 access token

Go to this url: https://gen3.theanvil.io login, then click on the profile link. There you can create an access credential. Download this json file and remember its location.

# Load access token from the credentials file and set Gen3 login url

```{r}
gen3token=fromJSON("credentials.json")
url="https://gen3.theanvil.io/user/credentials/cdis/access_token"
```

# Exchange this token for a bearer token, and extract the token part

```{r}
bearertokendata=POST(url,body=gen3token, encode="json")
bearertoken=as.character(fromJSON(content(bearertokendata,"text"))$access_token)
```

# Set up a query

The first query we will do is to find all of the projects that we have access to.

This query will return the project id and gen3 id for each project

```{r}
query = '{"query":"{project(first:0){project_id id}}"}';
```

# Set up the query endpoint, execute this query, and get the result

```{r}
url2="https://gen3.theanvil.io/api/v0/submission/graphql/"
result=POST(url2, body=query, encode="json",httr::add_headers(Authorization=paste("Bearer",bearertoken)))

fromJSON(content(result,"text"))
```

# Get schema types for Gen3. These contain the root entities for queries.

```{r}
query = '{"query":"{__schema {types {name}}}"}';
result=POST(url2, body=query, encode="json",httr::add_headers(Authorization=paste("Bearer",bearertoken)))
fromJSON(content(result,"text"))

```

# Inspect Subjects

We can get the fields available in the subject schema like this:

```{r}
myl=list(query='{__type(name: "subject") {name fields{name}}}')
query=toJSON(myl,auto_unbox=TRUE)
result=POST(url2, body=query, encode="json",httr::add_headers(Authorization=paste("Bearer",bearertoken)))
fromJSON(content(result,"text"))
```

These fields are the basis of data queries.


# Inspect Subject Phenodata

This lets you search across every study you have access to. I am limiting this to 10 results. To get all of the data, change (first:10) to (first:0)

```{r}
myl=list(query='{
  subject(first:10) {
    id
    project_id
    affected_status
  }
}')
query=toJSON(myl,auto_unbox=TRUE)
result=POST(url2, body=query, encode="json",httr::add_headers(Authorization=paste("Bearer",bearertoken)))
fromJSON(content(result,"text"))
```


# Inspect Sample Data

Similarly, we can ge the fields for samples.

```{r}
myl=list(query='{__type(name: "sample") {name fields{name}}}')
query=toJSON(myl,auto_unbox=TRUE)
result=POST(url2, body=query, encode="json",httr::add_headers(Authorization=paste("Bearer",bearertoken)))
fromJSON(content(result,"text"))
```

These fields can be queried as such

```{r}
myl=list(query='{
  sample(first:10) {
    id
    rin_number
  }
}')
query=toJSON(myl,auto_unbox=TRUE)
result=POST(url2, body=query, encode="json",httr::add_headers(Authorization=paste("Bearer",bearertoken)))
fromJSON(content(result,"text"))
```

# Inspect Sequencing

```{r}
myl=list(query='{__type(name: "sequencing") {name fields{name}}}')
query=toJSON(myl,auto_unbox=TRUE)
result=POST(url2, body=query, encode="json",httr::add_headers(Authorization=paste("Bearer",bearertoken)))
fromJSON(content(result,"text"))
```

Which can be queried as such

```{r}
myl=list(query='{sequencing{id file_name}}')
query=toJSON(myl,auto_unbox=TRUE)
result=POST(url2, body=query, encode="json",httr::add_headers(Authorization=paste("Bearer",bearertoken)))
fromJSON(content(result,"text"))
```

# Filtering

Queries can specify filtering parameters.

For example:

```{r}
myl=list(query='{
  subject(first:10,project_id:"open_access-1000Genomes") {
    id
    project_id
    sex
  }
}')
query=toJSON(myl,auto_unbox=TRUE)
result=POST(url2, body=query, encode="json",httr::add_headers(Authorization=paste("Bearer",bearertoken)))
fromJSON(content(result,"text"))
```
